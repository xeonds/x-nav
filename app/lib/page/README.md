# 页面说明+功能文档

这里写点想做的功能，后面跟上

1. 主页
2. 地图
    - 更有用的地图页
      - 团骑&消息&成员实时位置展示
      - 完善的快速导航功能
      - 骑行记录功能
        - A屏息屏显示低功耗导航
        - 记录模式更加无感，后台服务一样的存在，不阻塞其他功能的使用
      - 历史路段实时比较功能
        - 匹配到当前点和某一路段起点重合，并走完了特定长度的一段后，开始卡片展示此刻和之前路段的秒差
        - 路段完成后，或者当前轨迹偏离一定距离后判定重合轨迹结束，给出实时统计信息反馈，例如秒差，均速，功率等
        - 可选开启
    - 测绘功能
      - 地图页增加测绘，支持测距和测量高程数据和爬升数据等
      - 支持按路径测绘，以及轻量级的导航功能
    - 支持轻量级的轨迹记录功能，格式导出为fit
3. 路线库
    - 更强大完备的路线库
    - gpx库修复，支持更多的路书编辑功能
4. 骑行历史
    - 更详细的路段信息分析
    - 更详细的骑行记录分析
      - 各种fit文件中已有的数据
      - 更多的图表
      - 地图层支持叠加显示热力图
5. 我的
    - 个人数据备份与恢复
    - 退出确认
    - 离线路网+离线路径计算功能
      - 交叉编译OSRM计算库
      - 离线路网数据包管理
    - 离线地图包功能
    - 信息分析缓存功能
      - sqlite存储分析后的fit数据和gpx数据
      - 分析的最佳成绩等使用不同的数据表来存储
      - 插入新记录后自动开始增量分析
      - 借助多阶段的缓存加速app速度，减少重复计算的性能开销
    - 更多数据格式的支持
    - 地图抽离为一个通用组件，支持各个功能页面使用，同时便于优化性能
    - 更换fitparser库为更正式更完善的库

## 主页

目前只是信息展示，后面可以加点功能入口之类的

- 周骑行量可视化
- 月骑行日历+月骑行量统计
- 骑行最佳历史记录列表

## 地图

作为历史记录和路书的展示处。同时作为地图本身发挥指路作用，支持短途导航功能，记录功能以及实时算路功能。

- [x]地图展示，支持地图瓦片缓存功能
- [x]路书展示
- [x]骑行历史展示，支持热力图模式
- [x]定位当前位置
- 测算功能
  - 地图页增加测算支持，支持测距和测量高程数据和爬升数据等
  - 支持按路径测绘，以及轻量级的导航功能

### 测算功能

信号差时需要能够离线计算当前点到目标点的路线，支持测算距离/爬升/海拔数据等

- 测算当前点到目标点的距离/爬升/海拔数据等
- 计算当前点到目标点的路线
  - 算完的路线可以保存为路书/导出分享为gpx文件

测算方式为，增加途径点，展示测算数据
另外也能单点测算。对于沿途选择的点，显示其高程数据、直线距离等。

1. 场景描述

在外骑行时有时候需要一些简单的信息规划接下来一小段的行程。比如
- 当前位置的高度信息
- 到下一个点位的高程变化信息
- 某个点位的高程信息
- 接下来的爬升数据，坡度百分比均值和最大值
- 直线距离和路径距离
测量这些之后，可以快速知道后面一段路线的体力消耗情况，以及当前位置到目标点位的距离

因为测量只要求简单、快速，所以就不使用路网规划了，直接使用直线距离。

2. 需求描述

地图页中点击测算fab进入测算模式，用户可以在地图上选择点位。用户可以在点位列表中查看到所有选择的点位。
用户可以移动地图并点击添加来添加目标点位。
点位列表非空时，展示点位间高程信息和距离，爬升，坡度百分比等，并给出一个简单的海拔变化曲线。
完成后用户可以返回或者点击退出按钮来退出测算模式。

### 点位收藏

添加收藏按钮，可以收藏点位到数据库中。同时地图可设置展示收藏的点位。

### 信息卡片

对于路线和点位，展示其详细信息以及直线距离等测算信息。

这里的交互得好好设计

## 路线库/路书

展示所有的路书，且支持查看路书详情

因为gpx库的bug，目前不支持编辑路书的一些字段，只以为默认文件名展示路书轨迹。

- 更强大完备的路线库
  - 路线的多参数查询和管理
- 展示路线长度
  - 以及其他有用的信息，包括沿途的海拔折线图，平均坡度百分比，爬坡信息分析等
- 支持设置路书/赛段flag，设置为赛段的路径才会进行赛段匹配操作
- 路线轨迹展示
- 路书导入导出
- 路书制作
- 路书信息编辑
- 展示路书详细信息，包括爬升和任意点的海拔信息等

### 路书制作

目前支持混合手动/路网算法制作任意自由度路书，路书轨迹点的重定位/排序功能

后续可以尝试支持添加其他gpx路径轨迹进行路线组合，创建反向路线，路线信息展示

- 路线信息展示：路线里程，预估时间，路线爬升信息和海拔信息折线图等
- 引用路线库/骑行记录轨迹，并支持修剪片段来组合使用
  - 作为一个实体在路径点列表中展示
  - 支持定义路线片段的方向
  - 路线点列表中展示点类型，是导航点/自定义点/路书片段/骑行记录片段
- 创建反向路线
  - 对于本次创建的路线进行反向路线的创建，点击后保存为xxx-反向，不退出编辑器
  - 暂时不考虑双车道/来去路径不同的问题，直接将点序列反转

## 骑行历史

展示骑行历史记录列表，并支持分析单次骑行记录的详细信息

目前主要包括路段匹配和最佳里程用时记录，分时段最大功率记录，最大爬升/海拔/功率/速度等记录

- 骑行详细信息展示
- 本次最佳成绩
- 路段匹配
- 数据图表展示
- 子区间信息展示

### 路段分析

支持子路段记录排名，目前不支持更详细的子区间信息查看，只能看看均速用时排名这些的

- 路段地图
- 路段信息统计
- 路段历史记录及排名

## 我的

一堆修复用小功能分重分析功能，以及帮助文档

后续支持管理一些功能的开关，以及一些策略的选择

- 计算缓存功能开关

>这是一个骑行app的地图页面，请你实现测算功能和导航功能，以及一个轻量级的路径记录功能（暂时存储到json文件中）和一个全屏码表页面，以及一个他人位置显示功能。测算的数据包括路径的海拔数据、路径的长度和路径的爬升、坡度百分比数据；轻量级的导航功能支持点选地图目标点，并自动规划路，在顶部显示下一个动作，并在fab区域显示一个小的暂停/停止按钮结束导航。
>
>我需要你好好思考ui和交互的设计，这是重点。导航似乎可以是测算的前置功能，因为测算的路径一般是能走的路线。所以你可以将导航功能移动到测算结果区中。
>
>测算的路线高程数据可以使用折线图展示。
>
>顶部的导航提示可以是一个小的圆角的长条形带有页边距的悬浮卡片，类似于弹出的消息通知一样，要求尽可能简洁且不占用过多用户界面空间。
>
>界面设计的要求：我希望这一切都在这个地图页面中进行，而无需进入或跳转到其他页面中。
>
>此外你可以添加一个轻量级的路径记录功能，点击按钮即可记录当前用户经过的轨迹和轨迹上每一点的时间戳
>
>另外可以添加一个全屏码表页面，类似码表界面，显示速度、里程、时间、简洁版地图、导航指示等信息，支持屏幕常亮，支持锁定屏幕防止误触、支持A屏黑风格
>
>以及，他人位置显示功能，我的项目中有web端，你可以结合它来完成位置上报和显示
>
>还有，赛段实时匹配功能。本地存储中有很多路段数据，在骑行过程中若是进入了某个赛段，则可以以卡片的形式实时展示当前状态和历史记录的秒差数据。

### 骑行定位

使用PIN完成组团识别。以第一个用户为准，几个用户在1分钟内输入同一个PIN则可以加入同一个定位group中。

轮询/WebSocket广播定位和其他状态。

### 路线规划

1. 场景描述

我作为用户，今天想决定一个骑行路线。我可以先在路线库中进行筛选，选择一个我觉得可以重复去骑行的路线（刷老路线），或者我今天想纯粹探索新路线，刷一刷新里程。我希望完成路线规划之后可以统计这次有多少新里程。

这种情况下，我一般会想几个路径点，然后以这几个途径点为基础，开始规划。其中我可能会先不分顺序地都列出来然后再根据它们在地图的位置决定它们的顺序。

另外我也可能会想要在一些现有路线的基础上增加几个自己想去的点。这样的话我的行程规划就需要包含：原来的路线片段，以及我想途经的点。选好之后我应该可以排序它们并且对于路线我可以分割为任意片段并裁剪任意一段，跟视频编辑的操作有点像。

完成之后我可以把路线分享给别人，或者在巡航模式里添加这个路线，或者以后码表做出来了给它导入来导航等。
